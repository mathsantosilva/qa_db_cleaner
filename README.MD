# ğŸ§¹ QA DB Cleaner

Este projeto Ã© um utilitÃ¡rio Python para automatizar a **limpeza de bancos de QA** em uma instÃ¢ncia SQL Server. Ele identifica bancos marcados como "pode apagar", executa o `DROP DATABASE`, registra a aÃ§Ã£o em uma tabela de histÃ³rico e aguarda a prÃ³xima execuÃ§Ã£o em uma quantidade de dias determinados.

## ğŸ“¦ Estrutura do Projeto

```
qa_db_cleaner/
â”œâ”€â”€ logs/                                # Pasta para arquivos de log
â”‚   â””â”€â”€ qa_db_cleaner.log
â”‚
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ banco_repository.py              # OperaÃ§Ãµes com controle e histÃ³rico de bancos
â”‚   â”œâ”€â”€ config.py                        # ConfiguraÃ§Ãµes de conexÃ£o
â”‚   â”œâ”€â”€ database.py                      # ConexÃ£o e funÃ§Ãµes genÃ©ricas de banco
â”‚   â”œâ”€â”€ execucao.py                      # Valida e controla a execuÃ§Ã£o do programa
â”‚   â”œâ”€â”€ logger.py                        # ConfiguraÃ§Ã£o de logging para o projeto
â”‚   â”œâ”€â”€ main.py                          # Ponto de entrada
â”‚   â””â”€â”€ process.py                       # LÃ³gica de exclusÃ£o
â”‚
â”œâ”€â”€ sql_scripts/
â”‚   â””â”€â”€ db_creation/
â”‚       â””â”€â”€ create_qa_management.sql     # Script de criaÃ§Ã£o do banco de controle
â”‚   â””â”€â”€ jobs/
â”‚       â””â”€â”€ job_sync_control.sql         # Script utilizado para select/insert dos bancos da instancia no banco de controle
â”‚
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ test_banco_repository.py
â”‚   â”œâ”€â”€ test_dropper.py
â”‚   â””â”€â”€ mocks/
â”‚       â””â”€â”€ db_mock.py
â”‚
â”œâ”€â”€ requirements.txt
â””â”€â”€ README.md
```

## âš™ï¸ Funcionalidades

- ğŸ” Lista todos os registros do banco `qa_management`
- âœ… Filtra os bancos com `pode_apagar = true` e `data_expiracao < GETDATE()`
- ğŸ§¨ Executa `DROP DATABASE` nesses bancos
- ğŸ“ Registra a aÃ§Ã£o na tabela `historico_bancos_qa`
- ğŸ—‘ï¸ Deleta o registro da tabela `bancos_qa`

## ğŸ“œ Regras
- Os bancos contidos na instancia serÃ£o adicionados no banco `bancos_qa` com expiraÃ§Ã£o configurÃ¡vel
  - A regra de expiraÃ§Ã£o estÃ¡ contida dentro do job `Sync_Bancos_QA` na etapa `InsertDatabases`
- Os registros contidos na tebela `bancos_qa` serÃ£o ignorados caso tenham `pode_apagar = False` mesmo que a data de expiraÃ§Ã£o esteja menor que o dia atual
- Se o `process_drop_database()` falhar, o programa nÃ£o irÃ¡ para os passos seguintes `process_insert_log` e `process_delete_register`
- Todas as aÃ§Ãµes serÃ£o logadas com o seu devido tipo `INFO`, `WARNING` e `ERROR`

## ğŸ§© Estrutura das Tabelas

### `bancos_qa` (Controle)

| Campo           | Tipo       | DescriÃ§Ã£o                       |
|-----------------|------------|---------------------------------|
| id              | INT        | ID autoincremento               |
| nome_banco      | VARCHAR    | Nome do banco                   |
| data_insercao   | DATETIME   | Quando foi inserido no controle |
| data_expiracao  | DATETIME   | Quando pode ser excluÃ­do        |
| pode_apagar     | BIT        | Flag para controle de limpeza   |

### `historico_bancos_qa` (Log)

| Campo           | Tipo       | DescriÃ§Ã£o                             |
|-----------------|------------|---------------------------------------|
| id              | INT        | ID autoincremento                     |
| nome_banco      | VARCHAR    | Nome do banco excluÃ­do                |
| acao            | VARCHAR    | Tipo de aÃ§Ã£o (ex: 'exclusao')         |
| data_acao       | DATETIME   | Data da aÃ§Ã£o executada                |
| obs             | VARCHAR    | tipo da execuÃ§Ã£o (ex: 'Periodica')    |

## ğŸ› ï¸ ConfiguraÃ§Ãµes
### Arquivo `.env`
- SerÃ¡ necessÃ¡rio criar o arquivo manualmente, nele serÃ¡ armazenado todas as informaÃ§Ãµes de acesso do banco
- Se o arquivo nÃ£o foi encontrado na raiz do programa, ele nÃ£o irÃ¡ conseguir efetuar a busca pelos bancos
- Se o arquivo for inserido apÃ³s o inÃ­cio do programa, serÃ¡ necessÃ¡rio finalizar o processo e iniciar novamente

### Exemplo arquivo .env
```dotenv
# ConfiguraÃ§Ãµes de conexÃ£o com o banco de dados SQL Server
DB_DRIVER=ODBC Driver 17 for SQL Server
DB_SERVER=localhost
DB_DATABASE=qa_management
DB_USERNAME=seu_usuario
DB_PASSWORD=sua_senha
```
### Arquivo `Yaml`
- O arquivo config.yaml serÃ¡ criado apÃ³s a primeira execuÃ§Ã£o do programa
- Por padrÃ£o o campo `tempo_de_espera` vai vir com o valor de 10 dias, podendo ser alterado a qualquer momento durante a execuÃ§Ã£o do programa
- O campo `ultima_execucao` sempre irÃ¡ guardar a data da Ãºltima execuÃ§Ã£o ou vir como Null caso nÃ£o tenha realizado nenhuma execuÃ§Ã£o
- O arquivo yaml pode ser modificado ou excluÃ­do a qualquer momento do programa em execuÃ§Ã£o que ele irÃ¡ criar/alterar sem problemas

### Exemplo arquivo Yaml
```yaml
tempo_de_espera: 10
ultima_execucao: 03-06-2025-10-44
```


## ğŸš€ Como executar o programa em Windows/Linux
1. **Configure a conexÃ£o no `.env`:**

Para manter as credenciais seguras e separar a configuraÃ§Ã£o do cÃ³digo, este projeto utiliza um arquivo `.env`.
Crie um arquivo chamado `.env` na mesma pasta do programa

2 - **Inicie o programa pela primeira vez**

## ğŸ–¥ï¸ Como executar o projeto em python

1. **Instale as dependÃªncias:**

```bash
pip install -r requirements.txt
```

2. **Realize a criaÃ§Ã£o do arquivo `.env`**
- Crie um arquivo chamado .env na raiz do projeto com o conteÃºdo apresentado acima

3. **Execute o script principal:**

```bash
python src/main.py
```

## ğŸ§ª Testes UnitÃ¡rios

Use `pytest` para rodar os testes:

```bash
pytest tests/
```

## ğŸ›¡ï¸ Boas prÃ¡ticas aplicadas

- SeparaÃ§Ã£o de responsabilidades (cada mÃ³dulo faz uma coisa)
- Projeto preparado para testes unitÃ¡rios
- Facilmente extensÃ­vel para log externo, e-mails, agendamentos etc.
- Simples de integrar com o SQL Server Agent Job

## ğŸ‘¨â€ğŸ’» Autor
Este projeto foi estruturado com foco em automaÃ§Ã£o de ambientes de QA e manutenibilidade de longo prazo.
